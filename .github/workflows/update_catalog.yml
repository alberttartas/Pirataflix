name: Atualizar Cat√°logo Autom√°tico

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'download_iptv.py'
      - 'build.py'

jobs:
  update-catalog:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do reposit√≥rio
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Configurar Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
    
    - name: Instalar depend√™ncias
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Verificar arquivos
      run: |
        echo "üìÇ Listando arquivos na raiz:"
        ls -la
        echo ""
        echo "üìÇ Verificando download_iptv.py:"
        if [ -f "download_iptv.py" ]; then
          echo "‚úÖ Arquivo encontrado!"
          echo "üìù Primeiras linhas:"
          head -5 download_iptv.py
        else
          echo "‚ùå Arquivo N√ÉO encontrado!"
          exit 1
        fi
    
    - name: Baixar fontes IPTV
      run: |
        echo "üì° Executando download_iptv.py..."
        python download_iptv.py
        echo "üìÇ Listando arquivos baixados:"
        ls -la input_auto/ || echo "input_auto/ n√£o existe"
      continue-on-error: false
    
    - name: Listar pastas ap√≥s download
      run: |
        echo "üìÇ Pastas criadas:"
        ls -la input_auto/ || echo "input_auto/ n√£o existe"
        echo ""
        echo "üìÇ Conte√∫do de input_auto/:"
        find input_auto -type f -name "*.m3u" 2>/dev/null || echo "Nenhum arquivo .m3u encontrado"
    
    - name: Executar build do site
      run: |
        echo "üèóÔ∏è Gerando site..."
        python build.py
    
    - name: Verificar mudan√ßas
      id: git-check
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add iptv_playlists/ web/ input_auto/
        if git diff --staged --quiet; then
          echo "‚úÖ Nenhuma mudan√ßa para commit"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "üì¶ Mudan√ßas detectadas!"
          echo "changed=true" >> $GITHUB_OUTPUT
          git status
        fi
    
    - name: Commit e push
      if: steps.git-check.outputs.changed == 'true'
      run: |
        git commit -m "ü§ñ Atualiza√ß√£o autom√°tica do cat√°logo [skip ci]"
        git pull --rebase origin main
        git push
    
    - name: Upload de logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: update-logs
        path: logs/
        retention-days: 7
