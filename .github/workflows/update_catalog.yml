name: Atualizar CatÃ¡logo AutomÃ¡tico

on:
  schedule:
    # Roda todo dia Ã s 03:00 UTC (00:00 BRT)
    - cron: '0 3 * * *'
  workflow_dispatch:  # Permite executar manualmente
  push:
    branches: [ main ]
    paths:
      - 'download_iptv.py'
      - 'build.py'
      - 'input_auto/**'

jobs:
  update-catalog:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do repositÃ³rio
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Pega todo o histÃ³rico para commit
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Baixar fontes IPTV
      run: |
        echo "ðŸ“¡ Baixando fontes do iptv-org..."
        python download_iptv.py
      continue-on-error: true  # NÃ£o para se falhar
    
    - name: Executar build do site
      run: |
        echo "ðŸ—ï¸ Gerando site..."
        python build.py
    
    - name: Verificar mudanÃ§as
      id: git-check
      run: |
        git status --porcelain
        if [ -n "$(git status --porcelain)" ]; then
          echo "ðŸ“¦ MudanÃ§as detectadas!"
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… Nenhuma mudanÃ§a detectada"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit e push das mudanÃ§as
      if: steps.git-check.outputs.changed == 'true'
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add input_auto/ web/ iptv_playlists/ data.json
        git commit -m "ðŸ¤– AtualizaÃ§Ã£o automÃ¡tica do catÃ¡logo [skip ci]"
        git push
    
    - name: Criar arquivo de log
      run: |
        LOG_DIR="logs"
        mkdir -p $LOG_DIR
        LOG_FILE="$LOG_DIR/update_$(date +'%Y%m%d_%H%M%S').log"
        echo "ðŸ“ Criando log: $LOG_FILE"
        {
          echo "=== ATUALIZAÃ‡ÃƒO $(date) ==="
          echo "Status do download: ${{ job.status }}"
          echo "MudanÃ§as detectadas: ${{ steps.git-check.outputs.changed }}"
          echo "================================"
        } > $LOG_FILE
    
    - name: Upload de logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: update-logs
        path: logs/
        retention-days: 7
