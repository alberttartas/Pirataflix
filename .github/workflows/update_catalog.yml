name: Atualizar CatÃ¡logo AutomÃ¡tico

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'download_iptv.py'
      - 'build.py'

jobs:
  update-catalog:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do repositÃ³rio
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Configurar Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
    
    - name: Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Verificar arquivos
      run: |
        echo "ðŸ“‚ Listando arquivos na raiz:"
        ls -la
        echo ""
        echo "ðŸ“‚ Verificando download_iptv.py:"
        if [ -f "download_iptv.py" ]; then
          echo "âœ… Arquivo encontrado!"
          echo "ðŸ“ Primeiras linhas:"
          head -5 download_iptv.py
        else
          echo "âŒ Arquivo NÃƒO encontrado!"
          exit 1
        fi
    
    - name: Baixar fontes IPTV
      run: |
        echo "ðŸ“¡ Executando download_iptv.py..."
        python download_iptv.py
        echo "ðŸ“‚ Listando arquivos baixados:"
        ls -la input_auto/ || echo "input_auto/ nÃ£o existe"
      continue-on-error: false
    
    - name: Listar pastas apÃ³s download
      run: |
        echo "ðŸ“‚ Pastas criadas:"
        ls -la input_auto/ || echo "input_auto/ nÃ£o existe"
        echo ""
        echo "ðŸ“‚ ConteÃºdo de input_auto/:"
        find input_auto -type f -name "*.m3u" 2>/dev/null || echo "Nenhum arquivo .m3u encontrado"
    
    - name: Executar build do site
      run: |
        echo "ðŸ—ï¸ Gerando site..."
        python build.py
    
    - name: Verificar mudanÃ§as
      id: git-check
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add iptv_playlists/ web/ input_auto/
        if git diff --staged --quiet; then
          echo "âœ… Nenhuma mudanÃ§a para commit"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "ðŸ“¦ MudanÃ§as detectadas!"
          echo "changed=true" >> $GITHUB_OUTPUT
          git status
        fi
    
    - name: Commit e push
  if: steps.git-check.outputs.changed == 'true'
  run: |
    git config pull.rebase true
    git pull origin main
    git push origin main

    
    - name: Upload de logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: update-logs
        path: logs/
        retention-days: 7
